<div class="header-search-container">
  <div class="search-input-wrapper">
    <i class="bi bi-search search-icon"></i>
    <input
      #searchInput
      type="text"
      class="form-control search-input"
      [formControl]="searchControl"
      placeholder="Search subscriptions, customers... (⌘K)"
      (focus)="onSearchFocus()"
    />
    <button *ngIf="searchControl.value" class="clear-btn" (click)="clearSearch()" type="button">
      <i class="bi bi-x"></i>
    </button>
    <div *ngIf="isLoading" class="spinner-border spinner-border-sm" role="status"></div>
    <kbd *ngIf="!isLoading && !searchControl.value" class="search-shortcut">⌘K</kbd>
  </div>
  
  <!-- Pipedrive-style overlay -->
  <div *ngIf="showResults" class="search-overlay" (click)="closeResults()">
    <div class="search-overlay-content" (click)="$event.stopPropagation()">
      <!-- Close Button -->
      <button class="close-overlay-btn" (click)="closeResults(); $event.stopPropagation()" type="button" aria-label="Close search">
        <i class="bi bi-x-lg"></i>
      </button>
      <!-- Left Sidebar: Categories -->
      <div class="search-categories">
        <div class="category-header">
          <i class="bi bi-grid-3x3-gap"></i>
          <span>All categories</span>
        </div>
        <div 
          class="category-item" 
          [class.active]="selectedCategory === 'all'"
          (click)="selectCategory('all')"
        >
          <i class="bi bi-grid-3x3-gap"></i>
          <span>All search results</span>
          <span class="category-count">{{ getTotalCount() }}</span>
        </div>
        <div 
          *ngFor="let category of categories"
          class="category-item"
          [class.active]="selectedCategory === category.type"
          (click)="selectCategory(category.type)"
        >
          <i [class]="'bi ' + category.icon"></i>
          <span>{{ category.label }}</span>
          <span class="category-count">{{ getCategoryCount(category.type) }}</span>
        </div>
      </div>

      <!-- Right Panel: Results -->
      <div class="search-results-panel">
        <div class="results-header">
          <span>{{ getResultsHeader() }}</span>
        </div>
        <div class="results-list" *ngIf="filteredResults.length > 0">
          <div
            *ngFor="let result of filteredResults; let i = index"
            [id]="'search-result-' + i"
            class="result-card"
            [class.selected]="selectedIndex === i"
            (click)="onResultClick(result)"
            (mouseenter)="onResultMouseEnter(i)"
          >
            <div class="result-icon-wrapper">
              <i [class]="'bi ' + getTypeIcon(result.type)"></i>
            </div>
            <div class="result-content-wrapper">
              <div class="result-title">
                <span [innerHTML]="highlightSearchTerm(result.title)"></span>
              </div>
              <div class="result-subtitle">
                <span [innerHTML]="highlightSearchTerm(result.subtitle)"></span>
              </div>
              <!-- Detailed Information -->
              <div class="result-details" *ngIf="result.details">
                <div class="detail-item" *ngIf="result.details.customerName && result.type === 'subscription'">
                  <i class="bi bi-person"></i>
                  <span>{{ result.details.customerName }}</span>
                </div>
                <div class="detail-item" *ngIf="result.details.status">
                  <span class="status-badge" [class.active]="result.details.status === 'Active'">
                    {{ result.details.status }}
                  </span>
                </div>
                <div class="detail-item" *ngIf="result.details.startDate && result.type === 'subscription'">
                  <i class="bi bi-calendar"></i>
                  <span>Started: {{ result.details.startDate }}</span>
                </div>
                <div class="detail-item" *ngIf="result.details.email && result.type !== 'subscription'">
                  <i class="bi bi-envelope"></i>
                  <span>{{ result.details.email }}</span>
                </div>
                <div class="detail-item" *ngIf="result.details.mobile && result.type !== 'subscription'">
                  <i class="bi bi-telephone"></i>
                  <span>{{ result.details.mobile }}</span>
                </div>
              </div>
              <div class="result-tags" *ngIf="result.tags && result.tags.length > 0">
                <span class="tag-pill" *ngFor="let tag of result.tags">{{ tag }}</span>
              </div>
            </div>
            <div class="result-actions">
              <i class="bi bi-chevron-right"></i>
            </div>
          </div>
        </div>
        <div class="no-results" *ngIf="filteredResults.length === 0 && !isLoading">
          <i class="bi bi-search"></i>
          <p>No results found for "{{ searchControl.value }}"</p>
        </div>
      </div>
    </div>
  </div>
</div>
